name: Prepare Integration Test

on:
  workflow_dispatch:
    inputs:
      image_prefix:
        description: 'Prefix for test images'
        required: false
        default: 'ghcrctl-test'
      cleanup:
        description: 'Cleanup test images after workflow'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}

jobs:
  setup-test-images:
    name: Setup Test Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build and push image 1: No SBOM, no provenance, single platform
      - name: Build and push test image 1 (no SBOM, no provenance, single platform)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/no-sbom.Dockerfile
          push: true
          platforms: linux/amd64
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:test-1
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build and push image 2: With SBOM and provenance, multiarch
      - name: Build and push test image 2 (with SBOM, with provenance, multiarch)
        id: push-with-sbom
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/with-sbom.Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          sbom: true
          provenance: mode=max
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:test-1
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:stable
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:newest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:classic-pat-test
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build and push image 3: With SBOM but no provenance, single platform
      - name: Build and push test image 3 (with SBOM, no provenance, single platform)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/with-sbom-no-provenance.Dockerfile
          push: true
          platforms: linux/amd64
          sbom: true
          provenance: false
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom-no-provenance:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom-no-provenance:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom-no-provenance:test-1
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build and push image 4: No SBOM, no provenance, multiarch
      - name: Build and push test image 4 (no SBOM, no provenance, multiarch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/no-sbom-no-provenance.Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          sbom: false
          provenance: false
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-trivial-base:latest
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom-no-provenance:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom-no-provenance:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom-no-provenance:test-1
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build and push image 5: Cosign-signed (signature + SBOM attestation via cosign)
      - name: Build and push test image 5 (for cosign signing)
        id: push-cosign
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/cosign-signed.Dockerfile
          push: true
          platforms: linux/amd64
          sbom: false
          provenance: false
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-cosign-signed:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-cosign-signed:v1.0
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Install cosign
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      # Sign the image with cosign (keyless signing via OIDC)
      - name: Sign image with cosign
        env:
          DIGEST: ${{ steps.push-cosign.outputs.digest }}
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-cosign-signed
        run: |
          cosign sign --yes "${IMAGE}@${DIGEST}"

      # Create SBOM attestation with cosign
      - name: Generate SBOM for cosign attestation
        env:
          DIGEST: ${{ steps.push-cosign.outputs.digest }}
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-cosign-signed
        run: |
          # Generate a minimal SPDX SBOM
          cat > sbom.spdx.json << EOF
          {
            "spdxVersion": "SPDX-2.3",
            "dataLicense": "CC0-1.0",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "ghcrctl-test-cosign-sbom",
            "documentNamespace": "https://example.com/ghcrctl-test",
            "creationInfo": {
              "created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "creators": ["Tool: ghcrctl-integration-test"]
            },
            "packages": [{
              "SPDXID": "SPDXRef-Package",
              "name": "test-package",
              "versionInfo": "1.0.0",
              "downloadLocation": "NOASSERTION"
            }]
          }
          EOF

      - name: Attest SBOM with cosign
        env:
          DIGEST: ${{ steps.push-cosign.outputs.digest }}
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-cosign-signed
        run: |
          cosign attest --yes --type spdxjson --predicate sbom.spdx.json "${IMAGE}@${DIGEST}"

      - name: Summary
        run: |
          echo "## Integration Test Images Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 1: No SBOM, No Provenance (Single Platform)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-no-sbom\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 2: With SBOM and Provenance (Multiarch)" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`, \`stable\`, \`newest\`, \`classic-pat-test\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-with-sbom\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 3: With SBOM, No Provenance (Single Platform)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-with-sbom-no-provenance\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 4: No SBOM, No Provenance (Multiarch)" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-no-sbom-no-provenance\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 5: Cosign-Signed (Signature + SBOM Attestation)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-cosign-signed\`" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts: .sig (signature), .att (SBOM attestation)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test with ghcrctl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# List images" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View versions for multiarch image with SBOM" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl versions ${{ inputs.image_prefix }}-with-sbom" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View graph for single platform image" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl graph ${{ inputs.image_prefix }}-no-sbom" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View graph for multiarch with SBOM and provenance" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl graph ${{ inputs.image_prefix }}-with-sbom" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
