name: Integration Test

on:
  workflow_dispatch:
    inputs:
      image_prefix:
        description: 'Prefix for test images'
        required: false
        default: 'ghcrctl-test'
      cleanup:
        description: 'Cleanup test images after workflow'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}

jobs:
  setup-test-images:
    name: Setup Test Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create test Dockerfiles
      - name: Create test Dockerfiles
        run: |
          # Simple test image with minimal content
          cat > Dockerfile.test1 << 'EOF'
          FROM alpine:3.19
          LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
          LABEL org.opencontainers.image.description="Test image without SBOM"
          LABEL test.image.type="without-sbom"
          RUN echo "Test image 1 - no SBOM" > /test.txt
          CMD ["cat", "/test.txt"]
          EOF

          cat > Dockerfile.test2 << 'EOF'
          FROM alpine:3.19
          LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
          LABEL org.opencontainers.image.description="Test image with SBOM"
          LABEL test.image.type="with-sbom"
          RUN echo "Test image 2 - with SBOM" > /test.txt
          CMD ["cat", "/test.txt"]
          EOF

      # Build and push image WITHOUT SBOM
      - name: Build and push test image 1 (no SBOM)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.test1
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:test-${{ github.run_number }}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build and push image WITH SBOM
      - name: Build and push test image 2 (with SBOM)
        id: push-with-sbom
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.test2
          push: true
          sbom: true
          provenance: mode=max
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:test-${{ github.run_number }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:stable
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      - name: Summary
        run: |
          echo "## Integration Test Images Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 1: Without SBOM" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:v1.0\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:test-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 2: With SBOM and Provenance" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:v1.0\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:test-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:stable\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test with ghcrctl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# List images" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View graph for image without SBOM" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl graph ${{ inputs.image_prefix }}-no-sbom" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View graph for image with SBOM" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl graph ${{ inputs.image_prefix }}-with-sbom" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  test-with-ghcrctl:
    name: Test with ghcrctl
    runs-on: ubuntu-latest
    needs: setup-test-images
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'

      - name: Build ghcrctl
        run: go build -v -o ghcrctl .

      - name: Configure ghcrctl
        run: |
          ./ghcrctl config user ${{ github.repository_owner }}

      - name: Test listing images
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Listing images..."
          ./ghcrctl images --json | jq .

      - name: Test graph for image without SBOM
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking graph for image without SBOM..."
          ./ghcrctl graph ${{ inputs.image_prefix }}-no-sbom --tag latest --json | jq .

      - name: Test graph for image with SBOM
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking graph for image with SBOM..."
          ./ghcrctl graph ${{ inputs.image_prefix }}-with-sbom --tag latest --json | jq .

      - name: Verify SBOM presence
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check that the image with SBOM has attestations
          output=$(./ghcrctl graph ${{ inputs.image_prefix }}-with-sbom --tag latest --json)
          echo "$output"

          # This is a simple check - expand as needed based on ghcrctl output format
          echo "$output" | jq '.summary.sbom' | grep -q true && echo "✓ SBOM found" || echo "✗ SBOM not found"
