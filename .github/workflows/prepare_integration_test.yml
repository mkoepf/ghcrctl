name: Prepare Integration Test

on:
  workflow_dispatch:
    inputs:
      image_prefix:
        description: 'Prefix for test images'
        required: false
        default: 'ghcrctl-test'
      cleanup:
        description: 'Cleanup test images after workflow'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}

jobs:
  setup-test-images:
    name: Setup Test Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build, scan and push image 1: No SBOM, no provenance, single platform
      - name: Build test image 1 (no SBOM, no provenance, single platform)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/no-sbom.Dockerfile
          push: false
          load: true
          platforms: linux/amd64
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: image-local:${{ inputs.image_prefix }}-no-sbom-local
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      - name: Scan test image 1 (no SBOM, no provenance, single platform)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: image-local:${{ inputs.image_prefix }}-no-sbom-local
          exit-code: '1'
          ignore-unfixed: true

      - name: Push test image 1 (no SBOM, no provenance, single platform)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/no-sbom.Dockerfile
          push: true
          platforms: linux/amd64
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom:test-1
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build, scan and push image 2: With SBOM and provenance, multiarch
      - name: Build test image 2 (with SBOM, with provenance, multiarch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/with-sbom.Dockerfile
          push: false
          load: true
          platforms: linux/amd64,linux/arm64
          sbom: true
          provenance: mode=max
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: image-local:${{ inputs.image_prefix }}-with-sbom-local
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      - name: Scan test image 2 (with SBOM, with provenance, multiarch)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: image-local:${{ inputs.image_prefix }}-with-sbom-local
          exit-code: '1'
          ignore-unfixed: true

      - name: Push test image 2 (with SBOM, with provenance, multiarch)
        id: push-with-sbom
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/with-sbom.Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          sbom: true
          provenance: mode=max
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:test-1
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:stable
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:newest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom:classic-pat-test
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build, scan and push image 3: With SBOM but no provenance, single platform
      - name: Build test image 3 (with SBOM, no provenance, single platform)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/with-sbom-no-provenance.Dockerfile
          push: false
          load: true
          platforms: linux/amd64
          sbom: true
          provenance: false
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: image-local:${{ inputs.image_prefix }}-with-sbom-no-provenance-local
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      - name: Scan test image 3 (with SBOM, no provenance, single platform)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: image-local:${{ inputs.image_prefix }}-with-sbom-no-provenance-local
          exit-code: '1'
          ignore-unfixed: true

      - name: Push test image 3 (with SBOM, no provenance, single platform)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/with-sbom-no-provenance.Dockerfile
          push: true
          platforms: linux/amd64
          sbom: true
          provenance: false
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom-no-provenance:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom-no-provenance:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-with-sbom-no-provenance:test-1
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      # Build, scan and push image 4: No SBOM, no provenance, multiarch
      - name: Build test image 4 (no SBOM, no provenance, multiarch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/no-sbom-no-provenance.Dockerfile
          push: false
          load: true
          platforms: linux/amd64,linux/arm64
          sbom: false
          provenance: false
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: image-local:${{ inputs.image_prefix }}-no-sbom-no-provenance-local
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      - name: Scan test image 4 (no SBOM, no provenance, multiarch)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: image-local:${{ inputs.image_prefix }}-no-sbom-no-provenance-local
          exit-code: '1'
          ignore-unfixed: true

      - name: Push test image 4 (no SBOM, no provenance, multiarch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrationtests/no-sbom-no-provenance.Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          sbom: false
          provenance: false
          build-args: |
            GITHUB_REPOSITORY=${{ github.repository }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom-no-provenance:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom-no-provenance:v1.0
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.image_prefix }}-no-sbom-no-provenance:test-1
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}

      - name: Summary
        run: |
          echo "## Integration Test Images Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 1: No SBOM, No Provenance (Single Platform)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-no-sbom\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 2: With SBOM and Provenance (Multiarch)" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`, \`stable\`, \`newest\`, \`classic-pat-test\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-with-sbom\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 3: With SBOM, No Provenance (Single Platform)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-with-sbom-no-provenance\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image 4: No SBOM, No Provenance (Multiarch)" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`latest\`, \`v1.0\`, \`test-1\`" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ inputs.image_prefix }}-no-sbom-no-provenance\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test with ghcrctl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# List images" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View versions for multiarch image with SBOM" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl versions ${{ inputs.image_prefix }}-with-sbom" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View graph for single platform image" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl graph ${{ inputs.image_prefix }}-no-sbom" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View graph for multiarch with SBOM and provenance" >> $GITHUB_STEP_SUMMARY
          echo "ghcrctl graph ${{ inputs.image_prefix }}-with-sbom" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
